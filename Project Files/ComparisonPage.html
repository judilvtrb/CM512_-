<!-- HTML File (index.html) -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Hostel Hub | Comparison Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #29262E;
            color: #333;
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            min-height: 100vh;
        }

        .comparison-container {
            max-width: 1400px;
            margin: 0px;
            padding: 20px;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 40px;
        }

        #comparison-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 5px;
            height: 600px;
        }

        .left-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            height: 200px;
        }

        .right-section {
            height: 638px;
            margin-left: 2px;
        }

        .chart-container {
            background: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 315px;
            width: 545px;
        }

        .chart-container2 {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            width: 445px;
        }

        .chart-description {
            font-size: 15px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Chart specific styles */
        #value-price-chart,
        #detailed-scores-chart,
        #price-score-chart,
        #distance-chart {
            flex: 1;
            min-height: 300px;
            width: 100%;
        }

        #facilities-chart {
            flex: 1;
            min-height: 700px;
            width: 100%;
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            max-width: 200px;
        }

        /* Text styles */
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .header-container {
            display: flex;
            align-items: center;
            gap: 110px;
        }

        .legend {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: opacity 0.3s;
        }

        .legend-item:hover {
            opacity: 0.8;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 4px;
        }

        .legend-label {
            color: #ffffff;
            font-size: 16px;
            user-select: none;
        }

        .legend-item.inactive {
            opacity: 0.3;
        }

        .error-container {
            text-align: center;
            margin-top: 5px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            width: 600px;
            height: 150px;
        }
    </style>
</head>

<body>
    <div class="comparison-container">
        <div class="header-container">
            <h1>Japan Hostel Comparison</h1>
            <div class="legend" id="hostel-legend">
            </div>
        </div>
        <div id="comparison-content">
            <div class="left-section">
                <div class="chart-container">
                    <h2 class="chart-title">Rating Overview</h2>
                    <p class="chart-description">The parallel coordinates visualization shows the distribution of
                        ratings.</p>
                    <div id="value-price-chart"></div>
                </div>

                <div class="chart-container">
                    <h2 class="chart-title">Detailed Ratings Comparison</h2>
                    <p class="chart-description">The grouped bar chart shows strengths and weaknesses.</p>
                    <div id="detailed-scores-chart"></div>
                </div>

                <div class="chart-container">
                    <h2 class="chart-title">Price and Rating Comparison</h2>
                    <p class="chart-description">Bar chart shows prices while line chart indicates ratings.</p>
                    <div id="price-score-chart"></div>
                </div>

                <div class="chart-container">
                    <h2 class="chart-title">Distance from City Center</h2>
                    <p class="chart-description">Horizontal bars show the distance of each hostel.</p>
                    <div id="distance-chart"></div>
                </div>
            </div>

            <div class="right-section">
                <div class="chart-container">
                    <h2 class="chart-title">Facilities Comparison</h2>
                    <p class="chart-description">Dark blue dots indicate available facilities and services.</p>
                    <div id="facilities-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 顏色方案
        const colors = ["#FF9F87", "#7CD4FF", "#1D2B53"];

        // Track visibility state for each hostel
        let visibilityState = {};

        // Function to create and update legend
        function createLegend(data) {
            const legend = d3.select("#hostel-legend");

            data.forEach((hostel, i) => {
                visibilityState[hostel.hostel_name] = true;

                const legendItem = legend.append("div")
                    .attr("class", "legend-item")
                    .attr("data-hostel", hostel.hostel_name);

                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", colors[i]);

                legendItem.append("span")
                    .attr("class", "legend-label")
                    .text(hostel.hostel_name);

                legendItem.on("click", function () {
                    const hostelName = d3.select(this).attr("data-hostel");
                    toggleHostelVisibility(hostelName, i);
                });
            });
        }

        // Function to toggle hostel visibility
        function toggleHostelVisibility(hostelName, colorIndex) {
            visibilityState[hostelName] = !visibilityState[hostelName];
            const opacity = visibilityState[hostelName] ? 1 : 0;

            // Update legend style
            d3.select(`.legend-item[data-hostel="${hostelName}"]`)
                .classed("inactive", !visibilityState[hostelName]);

            // Immediately hide all tooltips
            d3.selectAll(".tooltip")
                .style("opacity", 0);

            // Update parallel coordinates chart
            d3.selectAll('#value-price-chart path')
                .filter(function (d) { return d && d.hostel_name === hostelName; })
                .style("opacity", opacity * 0.7)
                .style("pointer-events", visibilityState[hostelName] ? "auto" : "none");

            // Update detailed scores chart
            d3.selectAll('#detailed-scores-chart rect')
                .filter(function (d) { return d && d.hostel_name === hostelName; })
                .style("opacity", opacity)
                .style("pointer-events", visibilityState[hostelName] ? "auto" : "none");

            // Update price score chart
            d3.selectAll('#price-score-chart .bar')
                .filter(function (d) { return d && d.hostel_name === hostelName; })
                .style("opacity", opacity * 0.7)
                .style("pointer-events", visibilityState[hostelName] ? "auto" : "none");
            d3.selectAll('#price-score-chart .score-point')
                .filter(function (d) { return d && d.hostel_name === hostelName; })
                .style("opacity", opacity)
                .style("pointer-events", visibilityState[hostelName] ? "auto" : "none");

            // Update price score chart line
            if (window.updatePriceScoreLine) {
                window.updatePriceScoreLine();
            }

            // Update facilities chart
            d3.selectAll('#facilities-chart circle')
                .filter(function (d) { return d && d.hostel === hostelName; })
                .style("opacity", opacity)
                .style("pointer-events", visibilityState[hostelName] ? "auto" : "none");

            // Update distance chart
            d3.selectAll('.bar-group')
                .filter(function (d) { return d && d.hostel_name === hostelName; })
                .style("opacity", opacity)
                .style("pointer-events", visibilityState[hostelName] ? "auto" : "none");
        }
        // #endregion

        // 建立主要內容結構
        function createContentStructure() {
            return `
        <div id="comparison-content">
            <!-- 左半部的田字格布局 -->
            <div class="left-section">
                <div class="chart-container">
                    <p style="font-size: 20px; font-weight: bold; font-family: Times New Roman;">Rating Overview</p>
                    <p class="chart-description" style="margin-bottom: 5px">The parallel coordinates visualization shows the distribution of ratings.</p>
                    <div id="value-price-chart"></div>
                </div>
                
                <div class="chart-container">
                    <p style="font-size: 20px; font-weight: bold; font-family: Times New Roman">Detailed Ratings Comparison</p>
                    <p class="chart-description" style="margin-bottom: 5px">The grouped bar chart shows strengths and weaknesses.</p>
                    <div id="detailed-scores-chart"></div>
                </div>
                
                <div class="chart-container">
                    <p style="font-size: 20px; font-weight: bold; font-family: Times New Roman">Price and Rating Comparison</p>
                    <p class="chart-description" style="margin-bottom: 5px">Bar chart shows prices while line chart indicates ratings.</p>
                    <div id="price-score-chart"></div>
                </div>
                
                <div class="chart-container">
                    <p style="font-size: 20px; font-weight: bold; font-family: Times New Roman">Distance from City Center</p>
                    <p class="chart-description" style="margin-bottom: 5px">Horizontal bars show the distance of each hostel.</p>
                    <div id="distance-chart"></div>
                </div>
            </div>

            <!-- 右半部的設施比較圖 -->
            <div class="right-section">
                <div class="chart-container2" style="height: 100%;">
                    <p style="font-size: 20px; font-weight: bold; font-family: Times New Roman">Facilities Comparison</p>
                    <p class="chart-description" style="margin-bottom: 5px">Dark blue dots indicate available facilities and services.</p>
                    <div id="facilities-chart"></div>
                </div>
            </div>
        </div>
    `;
        }

        // #region Visialization: Radar
        /*// 創建雷達圖
        function createRadarChart(data) {
            const width = 600;
            const height = 600;
            const margin = 60;
            const radius = Math.min(width, height) / 2 - margin;
 
            const svg = d3.select("#radar-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);
 
            const features = [
                { key: "security", label: "Security" },
                { key: "location", label: "Location" },
                { key: "staff", label: "Staff" },
                { key: "atmosphere", label: "Atmosphere" },
                { key: "cleanliness", label: "Cleanliness" },
                { key: "facilities", label: "Facilities" }
            ];
            const angleSlice = (Math.PI * 2) / features.length;
 
            const rScale = d3.scaleLinear()
                .domain([0, 10])
                .range([0, radius]);
 
            // 繪製背景圓環和刻度
            const levels = 5;
            for (let j = 0; j < levels; j++) {
                const levelFactor = radius * ((j + 1) / levels);
 
                svg.append("circle")
                    .attr("cx", 0)
                    .attr("cy", 0)
                    .attr("r", levelFactor)
                    .style("fill", "none")
                    .style("stroke", "#292962")
                    .style("stroke-opacity", 0.2)
                    .style("stroke-width", "1px");
 
                svg.append("text")
                    .attr("x", 5)
                    .attr("y", -levelFactor)
                    .attr("dy", "0.4em")
                    .style("font-size", "11px")
                    .style("fill", "#292962")
                    .style("font-weight", "500")
                    .style("font-family", "Times New Roman")
                    .text((j + 1) * 2);
            }
 
            // 繪製軸線和標籤
            features.forEach((feature, i) => {
                const angle = i * angleSlice;
                const lineX2 = radius * Math.cos(angle - Math.PI / 2);
                const lineY2 = radius * Math.sin(angle - Math.PI / 2);
 
                svg.append("line")
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", lineX2)
                    .attr("y2", lineY2)
                    .style("stroke", "#292962")
                    .style("stroke-opacity", 0.3)
                    .style("stroke-width", "1px");
 
                const labelDistance = radius + 30; // 增加與圓心的距離
 
                const labelX = labelDistance * Math.cos(angle - Math.PI / 2);
                const labelY = labelDistance * Math.sin(angle - Math.PI / 2);
                let textAnchor = "middle";
 
                // 根據角度調整文字對齊和位置
                if (Math.abs(labelX) < 10) {
                    // 垂直文字位置微調
                    textAnchor = "middle";
                } else if (labelX > 0) {
                    // 右側文字左對齊
                    textAnchor = "start";
                } else {
                    // 左側文字右對齊
                    textAnchor = "end";
                }
 
                svg.append("text")
                    .attr("x", labelX)
                    .attr("y", labelY)
                    .style("text-anchor", textAnchor)
                    .style("font-size", "12px")
                    .style("fill", "#292962")
                    .style("font-weight", "500")
                    .style("font-family", "Times New Roman")
                    .text(feature.label);
            });
 
            // 創建雷達圖路徑
            const radarLine = d3.lineRadial()
                .radius(d => rScale(d.value))
                .angle((d, i) => i * angleSlice)
                .curve(d3.curveLinearClosed);
 
            // 繪製數據路徑
            data.forEach((hostel, i) => {
                const dataPoints = features.map(feature => ({
                    value: hostel[feature.key]
                }));
 
                svg.append("path")
                    .datum(dataPoints)
                    .attr("class", "radar-area")
                    .style("fill", colors[i])
                    .style("fill-opacity", 0.3)
                    .style("stroke", colors[i])
                    .style("stroke-width", "2px")
                    .attr("d", radarLine);
            });
 
            // 添加互動點和工具提示
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
 
            features.forEach((feature, i) => {
                const angle = i * angleSlice - Math.PI / 2;
 
                const sameScorePoints = data.filter(h =>
                    data.some(d => d[feature.key] === h[feature.key])
                );
 
                data.forEach((hostel, j) => {
                    const r = rScale(hostel[feature.key]);
                    const cx = r * Math.cos(angle);
                    const cy = r * Math.sin(angle);
 
                    svg.append("circle")
                        .attr("cx", cx)
                        .attr("cy", cy)
                        .attr("r", 4)
                        .style("fill", colors[j])
                        .style("stroke", "white")
                        .style("stroke-width", "1px")
                        .on("mouseover", (event) => {
                            // 找出相同分數的客棧
                            const sameScoreHostels = data.filter(d =>
                                d[feature.key] === hostel[feature.key]
                            );
 
                            const tooltipContent = sameScoreHostels
                                .map(h => `${h.hostel_name}`)
                                .join('<br/>') +
                                `<br/>${feature.label}: ${hostel[feature.key]}`;
 
                            tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);
                            tooltip.html(tooltipContent)
                                .style("font-family", "Times New Roman")
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", () => {
                            tooltip.transition()
                                .duration(500)
                                .style("opacity", 0);
                        });
                });
            });
 
            // 更新圖例
            const legendTitle = d3.select("#hostel-legend")
                .insert("p", ":first-child")  // 在最前面插入標題
                .attr("class", "legend-title")
                .style("font-size", "20px")
                .style("font-weight", "bold")
                .style("font-family", "Times New Roman")
                .style("margin-top", "8px")
                .style("margin-bottom", "15px")
                .text("Color - Hostel");
            const legend = d3.select("#hostel-legend");
            legend.selectAll(".legend-item").remove();
 
            data.forEach((hostel, i) => {
                const legendItem = legend.append("div")
                    .attr("class", "legend-item");
 
                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", colors[i]);
 
                legendItem.append("span")
                    .style("font-family", "Times New Roman")
                    .text(hostel.hostel_name);
            });
        }*/
        // #endregion

        // #region Visualization: BarChart Vertical
        function createPriceScoreChart(data) {
            const margin = { top: 15, right: 20, bottom: 30, left: 65 };
            const height = 250 - margin.top - margin.bottom;
            const width = d3.select("#price-score-chart").node().getBoundingClientRect().width - margin.left - margin.right - 10;

            const svg = d3.select("#price-score-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left - 20},${margin.top})`);

            // 更新 tooltip 樣式
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("pointer-events", "none")
                .style("background-color", "#ffffff")
                .style("border", "1px solid #eeeeee");

            // 比例尺設定保持不變
            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.hostel_name))
                .padding(0.3);

            const yPrice = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data, d => d.price * 30) * 1.2]);

            const yScore = d3.scaleLinear()
                .range([height, 0])
                .domain([0, 10]);

            // 軸的繪製保持不變
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .style("stroke-width", "1px")
                .selectAll("text")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .style("text-anchor", "middle")
                .attr("dx", "0")
                .attr("dy", "9px")
                .style("font-family", "Times New Roman");

            svg.append("g")
                .call(d3.axisLeft(yPrice))
                .style("font-weight", "bold")
                .append("text")
                .attr("fill", "#666")
                .attr("transform", "rotate(-90)")
                .attr("y", -35)
                .attr("x", -100)
                .attr("font-size", "14px")
                .attr("text-anchor", "middle")
                .style("font-family", "Times New Roman")
                .text("Price (TWD)");

            svg.append("g")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(yScore))
                .style("font-weight", "bold")
                .append("text")
                .attr("fill", "#666")
                .attr("transform", "rotate(-270)")
                .attr("font-size", "14px")
                .attr("y", -25)
                .attr("x", 100)
                .attr("text-anchor", "middle")
                .style("font-family", "Times New Roman")
                .text("Ratings");

            // 更新價格柱狀圖的 tooltip
            svg.selectAll(".price-bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar price-bar")
                .attr("x", d => x(d.hostel_name))
                .attr("y", d => yPrice(d.price * 30))
                .attr("width", x.bandwidth())
                .attr("height", d => height - yPrice(d.price * 30))
                .attr("fill", (d, i) => colors[i])
                .attr("opacity", 0.7)
                .style("pointer-events", d => visibilityState[d.hostel_name] ? "auto" : "none")
                .on("mouseover", function (event, d) {
                    if (visibilityState[d.hostel_name]) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("opacity", 1)
                            .style("stroke", "white")
                            .style("stroke-width", 2);

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(`
                    <div style="border: 2px; solid #eeeeee; font-weight:bold">
                        <p style="margin: 0; color: ${colors[data.indexOf(d)]}; padding-bottom:2px">
                            ${d.hostel_name}
                        </p>
                        <p style="margin: 0; color: black;">
                            Price: NT$ ${(d.price * 30).toFixed(0)}
                        </p>
                    </div>
                `)
                            .style("left", (event.pageX - 20) + "px")
                            .style("top", (event.pageY - 18) + "px");
                    }
                })
                .on("mouseout", function (event, d) {
                    const opacity = visibilityState[d.hostel_name] ? 0.7 : 0;
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("opacity", opacity)
                        .style("stroke-width", 0);

                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // 创建一个组来包含所有的线段
            const lineGroup = svg.append("g");

            // 修改评分线的绘制方式
            const line = d3.line()
                .x(d => x(d.hostel_name) + x.bandwidth() / 2)
                .y(d => yScore(d.summary_score))
                .defined(d => visibilityState[d.hostel_name]); // 只对可见的数据点绘制线段

            // 绘制评分线
            lineGroup.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#333")
                .attr("stroke-width", 2)
                .attr("d", line);

            // 评分点
            svg.selectAll(".score-point")
                .data(data)
                .enter()
                .append("circle")
                .attr("class", "score-point")
                .attr("cx", d => x(d.hostel_name) + x.bandwidth() / 2)
                .attr("cy", d => yScore(d.summary_score))
                .attr("r", 4)
                .attr("fill", "#333")
                .attr("stroke", "white")
                .attr("stroke-width", 1)
                .style("pointer-events", d => visibilityState[d.hostel_name] ? "auto" : "none")
                .on("mouseover", function (event, d) {
                    if (visibilityState[d.hostel_name]) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("r", 6);

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(`
                    <div style="border: 2px; solid #eeeeee; font-weight:bold">
                        <p style="margin: 0; color: ${colors[data.indexOf(d)]}; padding-bottom:2px">
                            ${d.hostel_name}
                        </p>
                        <p style="margin: 0; color: black;">
                            Ratings: ${d.summary_score.toFixed(1)}
                        </p>
                    </div>
                `)
                            .style("left", (event.pageX + 20) + "px")
                            .style("top", (event.pageY - 18) + "px");
                    }
                })
                .on("mouseout", function (event, d) {
                    const opacity = visibilityState[d.hostel_name] ? 1 : 0;
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 4)
                        .style("opacity", opacity);

                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // 在 toggleHostelVisibility 函数调用后更新线图
            function updateLine() {
                lineGroup.select("path")
                    .datum(data.filter(d => visibilityState[d.hostel_name]))
                    .attr("d", line);
            }

            // 将 updateLine 函数添加到全局作用域，以便 toggleHostelVisibility 可以调用它
            window.updatePriceScoreLine = updateLine;
        }
        // #endregion

        // #region Visualization: DotChart
        function createFacilitiesChart(data) {
            const margin = { top: 40, right: 40, bottom: 10, left: 200 };
            const height = 510;
            const width = d3.select("#facilities-chart").node().getBoundingClientRect().width - margin.left - margin.right;
            const ACTIVE_COLOR = "#292962";
            const INACTIVE_COLOR = "#d4d4d4";

            // 為每個類別定義標題的位置調整
            const categoryAdjustments = {
                'Free Items': {
                    offsetY: 60,
                    translateX: -200
                },
                'Facilities': {
                    offsetY: 200,
                    translateX: -200
                },
                'Services': {
                    offsetY: 145,
                    translateX: -200
                },
                'Dining': {
                    offsetY: 127,
                    translateX: -200
                }
            };

            const svg = d3.select("#facilities-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // 定義設施類別 (保持不變)
            const facilityCategories = {
                'Free Items': {
                    icon: '<i class="fas fa-gift" style="color: #29292E; font-size: 16px;"></i>',
                    items: ['free_airportTransfer', 'free_breakfast', 'free_cityMaps', 'free_cityTour', 'free_internetAccess', 'free_linen', 'free_parking', 'free_towel', 'free_wifi']
                },
                'Facilities': {
                    icon: '<i class="fas fa-home" style="color: #29292E; font-size: 16px;"></i>',
                    items: ['general_airConditioning', 'general_hotShower', 'general_microwave', 'general_securityLocker', 'general_washingMachine']
                },
                'Services': {
                    icon: '<i class="fas fa-concierge-bell" style="color: #29292E; font-size: 16px;"></i>',
                    items: ['service_24HourSecurity', 'service_laundry', 'service_luggageStorage', 'service_reception']
                },
                'Dining': {
                    icon: '<i class="fas fa-utensils" style="color: #29292E; font-size: 16px;"></i>',
                    items: ['foodDrink_cafe', 'foodDrink_bar', 'foodDrink_restaurant']
                }
            };

            // 設置比例尺
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.hostel_name))
                .range([0, width * 1.5])
                .padding(0.1);

            let yPosition = 0;
            const categoryPositions = {};

            // 計算每個類別的位置和高度
            Object.entries(facilityCategories).forEach(([category, { items }]) => {
                if (category !== 'Free Items') {
                    yPosition += 20;
                }

                categoryPositions[category] = {
                    start: yPosition,
                    height: items.length * 25,
                    items: items
                };

                yPosition += items.length * 25;
            });

            const totalHeight = yPosition - 40;
            const yScale = d3.scaleLinear()
                .domain([0, totalHeight])
                .range([0, height]);

            // 處理資料
            const processedData = [];
            data.forEach(hostel => {
                Object.entries(facilityCategories).forEach(([category, { items }]) => {
                    items.forEach(item => {
                        processedData.push({
                            hostel: hostel.hostel_name,
                            category: category,
                            item: item.split('_')[1],
                            value: hostel[item] === 'yes',
                            yPosition: categoryPositions[category].start +
                                categoryPositions[category].items.indexOf(item) * 25
                        });
                    });
                });
            });

            // 添加類別標題和分隔線 (保持原有邏輯)
            let prevSectionEnd = 0;
            Object.entries(facilityCategories).forEach(([category, { icon, items }], index) => {
                const categoryPos = categoryPositions[category];
                const adjustment = categoryAdjustments[category];

                let midPoint;
                if (index === 0) {
                    midPoint = yScale(categoryPos.height / 2);
                } else {
                    const sectionStart = prevSectionEnd;
                    const sectionEnd = yScale(categoryPos.start + categoryPos.height - 15);
                    midPoint = sectionStart + (sectionEnd - sectionStart) / 2;
                }

                midPoint += adjustment.offsetY;

                const group = svg.append("g")
                    .attr("transform", `translate(${adjustment.translateX}, ${midPoint})`);

                // 添加標題
                const fo = group.append("foreignObject")
                    .attr("width", 150)
                    .attr("height", 30)
                    .attr("transform", "rotate(-90)")
                    .append("xhtml:div")
                    .style("width", "100%")
                    .style("height", "100%")
                    .style("display", "flex")
                    .style("align-items", "center")
                    .style("justify-content", "center")
                    .style("gap", "5px")
                    .style("font-family", "Times New Roman")
                    .style("font-size", "15px")
                    .style("font-weight", "bold");

                fo.html(icon + ' ' + category);

                // 添加分隔線
                if (category !== 'Free Items') {
                    svg.append("line")
                        .attr("x1", -200)
                        .attr("x2", width + 30)
                        .attr("y1", yScale(categoryPos.start - 25))
                        .attr("y2", yScale(categoryPos.start - 25))
                        .style("stroke", "#ddd")
                        .style("stroke-width", "2px")
                        .style("stroke-dasharray", "3,3");
                }

                prevSectionEnd = yScale(categoryPos.start - 25);

                // 添加設施名稱
                items.forEach((item, index) => {
                    const yPos = categoryPos.start + index * 25;
                    svg.append("text")
                        .attr("x", -70)
                        .attr("y", yScale(yPos))
                        .attr("dy", "0.32em")
                        .style("font-family", "Times New Roman")
                        .style("font-size", "12px")
                        .style("font-weight", "bold")
                        .attr("text-anchor", "end")
                        .text(item.split('_')[1].charAt(0).toUpperCase() +
                            item.split('_')[1].slice(1).replace(/([A-Z])/g, ' $1'));
                });
            });

            // 添加圓點 - 修改 cx 的計算方式
            processedData.forEach(d => {
                svg.append("circle")
                    .attr("cx", xScale(d.hostel) + xScale.bandwidth() / 2 - 50)
                    .attr("cy", yScale(d.yPosition))
                    .attr("r", 5)
                    .attr("fill", d.value ? ACTIVE_COLOR : INACTIVE_COLOR)
                    .attr("opacity", d.value ? 1 : 0.8)
                    .attr("stroke", d.value ? "white" : "none")
                    .attr("stroke-width", d.value ? 1 : 0);
            });

            // 添加客棧名稱 - 確保與圓點對齊
            data.forEach((d, i) => {
                const words = d.hostel_name.split(' ');
                const lines = [];
                let currentLine = words[0];

                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    if (currentLine.length + word.length < 20) {
                        currentLine += " " + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);

                const text = svg.append("text")
                    .attr("x", xScale(d.hostel_name) + xScale.bandwidth() / 2 - 50)
                    .attr("y", -25)
                    .attr("text-anchor", "middle")
                    .style("fill", colors[i])
                    .style("font-family", "Times New Roman")
                    .style("font-size", "11px")
                    .style("font-weight", "bold");

                lines.forEach((line, index) => {
                    text.append("tspan")
                        .attr("x", xScale(d.hostel_name) + xScale.bandwidth() / 2 - 50)
                        .attr("dy", index === 0 ? "0em" : "1.2em")
                        .text(line);
                });
            });


            /*// 添加圖例
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width - 200}, -60)`);
    
            legend.append("rect")
                .attr("x", -10)
                .attr("y", -15)
                .attr("width", 200)
                .attr("height", 30)
                .attr("fill", "white")
                .attr("rx", 4)
                .attr("stroke", "#eee");
    
            legend.append("circle")
                .attr("cx", 0)
                .attr("cy", 0)
                .attr("r", 6)
                .attr("fill", ACTIVE_COLOR);
    
            legend.append("text")
                .attr("x", 15)
                .attr("y", 0)
                .attr("dy", "0.32em")
                .style("font-size", "12px")
                .style("font-family", "Times New Roman")
                .text("Served");
    
            legend.append("circle")
                .attr("cx", 80)
                .attr("cy", 0)
                .attr("r", 6)
                .attr("fill", INACTIVE_COLOR)
                .attr("opacity", 0.8);
    
            legend.append("text")
                .attr("x", 95)
                .attr("y", 0)
                .attr("dy", "0.32em")
                .style("font-size", "12px")
                .style("font-family", "Times New Roman")
                .text("Not Served");*/

        }
        // #endregion

        // #region Visualization: Barchart Horizontal
        function createDistanceChart(data) {
            const margin = { top: 0, right: 10, bottom: 50, left: 0 };
            const height = 250 - margin.top - margin.bottom;
            const width = d3.select("#distance-chart").node().getBoundingClientRect().width - margin.left - margin.right;

            const svg = d3.select("#distance-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const y = d3.scaleBand()
                .range([height, 0])
                .domain(data.map(d => d.hostel_name))
                .padding(0.1);

            const x = d3.scaleLinear()
                .range([0, width])
                .domain([0, d3.max(data, d => d.distance) * 1.2]);

            // 垂直軸線
            svg.append("line")
                .attr("x1", 0)
                .attr("x2", 0)
                .attr("y1", 0)
                .attr("y2", height)
                .style("stroke", "#292962")
                .style("stroke-width", 1);

            // x 軸
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .style("font-weight", "bold")
                .append("text")
                .attr("fill", "#666")
                .attr("x", width / 2)
                .attr("y", 37)
                .style("font-family", "Times New Roman")
                .attr("text-anchor", "middle")
                .text("Distance from City Center (km)")
                .style("font-weight", "bold")
                .style("font-size", "16px");

            // 創建條形組
            const barGroups = svg.selectAll(".bar-group")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "bar-group");

            // 繪製條形
            barGroups.append("rect")
                .attr("class", "bar")
                .attr("y", d => y(d.hostel_name))
                .attr("height", y.bandwidth())
                .attr("x", 0)
                .attr("width", d => x(d.distance))
                .attr("fill", (d, i) => colors[i])
                .attr("opacity", 0.8)
                .style("stroke", "none") // 初始無描邊
                .style("stroke-width", "0px");

            // 創建輔助線組
            const guidelineGroup = svg.append("g")
                .attr("class", "guideline-group");

            // 懸停事件處理
            barGroups
                .on("mouseover", function (event, d) {
                    const barY = y(d.hostel_name);

                    // 添加白色描邊
                    d3.select(this).select(".bar")
                        .transition()
                        .duration(200)
                        .style("stroke", "white")
                        .style("stroke-width", "2px");

                    // 添加輔助線
                    guidelineGroup.append("line")
                        .attr("class", "guideline")
                        .attr("x1", x(d.distance))
                        .attr("x2", x(d.distance))
                        .attr("y1", barY)
                        .attr("y2", height)
                        .style("stroke", "#666")
                        .style("stroke-width", "2px")
                        .style("stroke-dasharray", "3,3")
                        .style("opacity", 0)
                        .transition()
                        .duration(200)
                        .style("opacity", 1);
                })
                .on("mouseout", function () {
                    // 移除白色描邊
                    d3.select(this).select(".bar")
                        .transition()
                        .duration(200)
                        .style("stroke", "none")
                        .style("stroke-width", "0px");

                    // 移除輔助線
                    guidelineGroup.selectAll(".guideline")
                        .transition()
                        .duration(200)
                        .style("opacity", 0)
                        .remove();
                });

            // 添加標籤
            barGroups.append("text")
                .attr("class", "hostel-label")
                .attr("x", d => x(d.distance) / 2)
                .attr("y", d => y(d.hostel_name) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .style("text-anchor", "middle")
                .style("font-family", "Times New Roman")
                .style("fill", "#292962")
                .text(d => d.hostel_name)
                .style("font-weight", "bold");

            // 添加距離標籤
            barGroups.append("text")
                .attr("class", "distance-label")
                .attr("x", d => x(d.distance) + 5)
                .attr("y", d => y(d.hostel_name) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .style("font-family", "Times New Roman")
                .text(d => d.distance.toFixed(1) + " km")
                .style("font-weight", "bold");
        }
        // #endregion

        // #region Visualization: ParallelChart
        function createParallelCoordinatesChart(data) {
            const margin = { top: 20, right: 10, bottom: 30, left: 40 };
            const height = 250 - margin.top - margin.bottom;
            const width = d3.select("#value-price-chart").node().getBoundingClientRect().width - margin.left - margin.right;

            const svg = d3.select("#value-price-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left - 12},${margin.top})`);

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("pointer-events", "none")
                .style("background-color", "#ffffff")
                .style("border", "2px solid #eeeeee");

            const dimensions = ["price", "security", "location", "staff", "atmosphere", "cleanliness", "facilities"];

            const y = {};
            for (let dimension of dimensions) {
                y[dimension] = d3.scaleLinear()
                    .domain(dimension === "price" ?
                        [0, d3.max(data, d => d[dimension] * 30)] :
                        [0, 10])
                    .range([height, 0]);
            }

            const x = d3.scalePoint()
                .range([0, width])
                .domain(dimensions);

            function path(d) {
                return d3.line()(dimensions.map(dimension => {
                    const value = dimension === "price" ? d[dimension] * 30 : d[dimension];
                    return [x(dimension), y[dimension](value)];
                }));
            }

            // 找出最接近的軸
            function findClosestAxis(mouseX) {
                let closest = dimensions[0];
                let minDistance = Math.abs(x(dimensions[0]) - mouseX);

                dimensions.forEach(dim => {
                    const distance = Math.abs(x(dim) - mouseX);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closest = dim;
                    }
                });

                return minDistance < 30 ? closest : null;
            }

            // 生成 tooltip 內容
            function getTooltipContent(d, i, closestDim) {
                const value = closestDim === "price" ?
                    (d[closestDim] * 30).toFixed(1) + " TWD" :
                    d[closestDim].toFixed(1);

                return `
            <div>
                <p style="margin: 0; color: ${colors[i]}; font-weight: bold; padding-bottom:2px">
                    ${d.hostel_name}
                </p>
                <p style="margin: 0; color: black;">
                    <strong>${closestDim.charAt(0).toUpperCase() + closestDim.slice(1)}: ${value}</strong>
                </p>
            </div>
        `;
            }

            // 繪製軸
            dimensions.forEach(dimension => {
                const axis = svg.append("g")
                    .attr("transform", `translate(${x(dimension)},0)`)
                    .call(d3.axisLeft(y[dimension]));

                axis.selectAll(".tick text")
                    .style("font-size", "10px")
                    .style("font-weight", "bold");

                axis.append("text")
                    .style("fill", "#000")
                    .style("font-size", "10px")
                    .style("font-weight", "bold")
                    .attr("y", -10)
                    .attr("text-anchor", "middle")
                    .text(dimension === "price" ? "Price(TWD)" :
                        dimension.charAt(0).toUpperCase() + dimension.slice(1));
            });

            // 首先绘制主要路径
            data.forEach((d, i) => {
                const pathElement = svg.append("path")
                    .datum(d)
                    .attr("class", `parallel-path-${i}`)
                    .attr("fill", "none")
                    .attr("stroke", colors[i])
                    .attr("stroke-width", 3)
                    .attr("d", path)
                    .style("opacity", 0.7)
                    .style("pointer-events", visibilityState[d.hostel_name] ? "auto" : "none");
            });

            // 为每条路径添加交互层
            data.forEach((d, i) => {
                svg.append("path")
                    .datum(d)
                    .attr("class", `parallel-path-hover-${i}`)
                    .attr("fill", "none")
                    .attr("stroke", "transparent")
                    .attr("stroke-width", 15)
                    .attr("d", path)
                    .style("pointer-events", visibilityState[d.hostel_name] ? "auto" : "none")
                    .on("mouseover", function () {
                        if (visibilityState[d.hostel_name]) {
                            d3.select(`.parallel-path-${i}`)
                                .style("opacity", 1)
                                .style("stroke-width", 4);
                        }
                    })
                    .on("mouseout", function () {
                        if (visibilityState[d.hostel_name]) {
                            d3.select(`.parallel-path-${i}`)
                                .style("opacity", 0.7)
                                .style("stroke-width", 3);

                            tooltip.transition()
                                .duration(500)
                                .style("opacity", 0);
                        }
                    })
                    .on("mousemove", function (event) {
                        if (visibilityState[d.hostel_name]) {
                            const mouseX = d3.pointer(event)[0];
                            const mouseY = d3.pointer(event)[1];
                            const closestDim = findClosestAxis(mouseX);

                            if (closestDim) {
                                tooltip.transition()
                                    .duration(200)
                                    .style("opacity", .9);
                                tooltip.html(getTooltipContent(d, i, closestDim))
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY + 8) + "px");
                            } else {
                                tooltip.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                            }
                        }
                    });
            });
        }
        // #endregion

        // #region Visualization: BarChart TriVertical
        function createDetailedScoresChart(data) {
            const margin = { top: 10, right: 10, bottom: 40, left: 20 };
            const height = 250 - margin.top - margin.bottom;
            const width = d3.select("#detailed-scores-chart").node().getBoundingClientRect().width - margin.left - margin.right;

            const svg = d3.select("#detailed-scores-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const categories = ["atmosphere", "cleanliness", "facilities", "location", "security", "staff"];
            const categoryNames = {
                atmosphere: "Atmosphere",
                cleanliness: "Cleanliness",
                facilities: "Facilities",
                location: "Location",
                security: "Security",
                staff: "Staff",
            };

            const x0 = d3.scaleBand()
                .domain(categories)
                .range([0, width])
                .padding(0.1);

            const x1 = d3.scaleBand()
                .domain(data.map(d => d.hostel_name))
                .range([0, x0.bandwidth()])
                .padding(0.05);

            const y = d3.scaleLinear()
                .domain([0, 10])
                .range([height, 0]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x0).tickFormat(d => categoryNames[d]))
                .selectAll("text")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .style("font-family", "Times New Roman")
                .style("text-anchor", "middle");

            svg.append("g")
                .call(d3.axisLeft(y))
                .style("font-weight", "bold");

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("background-color", "#ffffff");

            categories.forEach(category => {
                const categoryGroup = svg.append("g")
                    .attr("transform", `translate(${x0(category)},0)`);

                const bars = categoryGroup.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("x", d => x1(d.hostel_name))
                    .attr("y", d => y(d[category]))
                    .attr("width", x1.bandwidth())
                    .attr("height", d => height - y(d[category]))
                    .attr("fill", (d, i) => colors[i]);

                // 增強互動效果
                bars.on("mouseover", (event, d) => {
                    // 只在元素可見時顯示 tooltip
                    if (visibilityState[d.hostel_name]) {
                        d3.select(event.currentTarget)
                            .transition()
                            .duration(200)
                            .style("opacity", 1)
                            .style("stroke", "white")
                            .style("stroke-width", 2);

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 1)
                            .style("border", "2px solid #eeeeee");
                        tooltip.html(`
                    <div>
                        <p style="margin: 0; color: ${colors[data.indexOf(d)]}; font-weight: bold; padding-bottom: 2px">
                            ${d.hostel_name}
                        </p>
                        <p style="margin: 0; color: black;">
                            <strong>${categoryNames[category]}: ${d[category].toFixed(1)}</strong>
                        </p>
                    </div>
                `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    }
                })
                    .on("mouseout", (event, d) => {
                        // 确保元素在鼠标移出时恢复正确的不透明度
                        const opacity = visibilityState[d.hostel_name] ? 1 : 0;
                        d3.select(event.currentTarget)
                            .transition()
                            .duration(200)
                            .style("opacity", opacity)
                            .style("stroke", "none");

                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            });
        }
        // #endregion

        // 頁面載入時初始化
        window.addEventListener('load', () => {
            try {
                const comparisonData = JSON.parse(localStorage.getItem('comparisonData') || '[]');

                if (!comparisonData.length || comparisonData.length < 2) {
                    document.getElementById('comparison-content').innerHTML = `
                    <div class="error-container" style="font-family: Times New Roman; line-height: 30px">
                        <h2>Unable to Load Comparison Data</h2>
                        <p>Please return to the list page and select 2-3 hostels for comparison</p>
                        <a href="HomePage.html" class="back-btn" style="margin-top: 20px;">Back to List</a>
                    </div>
                `;
                } else {
                    // 創建頁面結構
                    document.getElementById('comparison-content').innerHTML = createContentStructure();

                    createLegend(comparisonData);

                    // 依序創建各個圖表
                    //createRadarChart(comparisonData);
                    createParallelCoordinatesChart(comparisonData);  // 新增
                    createDetailedScoresChart(comparisonData);  // 新增
                    createPriceScoreChart(comparisonData);
                    createFacilitiesChart(comparisonData);
                    createDistanceChart(comparisonData);
                }

                // 清除已使用的數據
                localStorage.removeItem('comparisonData');
            } catch (error) {
                console.error('Error loading comparison data:', error);
                document.getElementById('comparison-content').innerHTML = `
                <div class="error-container" style="font-family: Times New Roman; line-height: 10px">
                    <h2 style="font-family: Times New Roman;>Error Loading Data</h2>
                    <p style="font-family: Times New Roman;>Please return to the list page and try comparison again</p>
                    <a href="ProjectTest.html" class="back-btn" style="margin-top: 20px; font-family: Times New Roman;">Back to List</a>
                </div>
            `;
            }
        });
    </script>
</body>

</html>